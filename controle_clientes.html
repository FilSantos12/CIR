<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Clientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        h2 {
            text-align: center;
            margin-top: 30px;
            font-weight: bold;
        }
        .container {
            max-width: 95%;
        }
        .table-responsive {
            margin-top: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        th {
            background-color: #ece072;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        tbody tr:hover {
            background-color: rgba(236, 224, 114, 0.3);
        }
        .input-group {
            max-width: 600px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #ece072;">
        <div class="container-fluid">
            <a href="index.php" class="text-dark" style="text-decoration: none;" title="Voltar para a página inicial">
                <i class="bi bi-arrow-left-circle-fill" style="font-size: 1.5rem;"></i>
                <span class="visually-hidden">Voltar</span>
            </a>
            <a class="navbar-brand ms-4" href="#">Controle Imposto de Renda</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto"></ul>
                <div class="d-flex align-items-center">
                    <button class="btn btn-dark" onclick="fecharPagina()">Sair</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Controle de Clientes</h2>
        <!-- Campo de busca -->
        <form id="formBusca" class="mb-4">
            <div class="input-group">
                <input type="text" id="nomeClienteInput" class="form-control" placeholder="Digite o nome do cliente" />
                <button type="submit" class="btn btn-primary">Buscar</button>
            </div>
        </form>
        <div id="listaClientes"></div>
    </div>

<div class="container mt-5">
    <h2 class="text-center">Lista de Clientes e Processos</h2>
    <div class="table-responsive">
        <table class="table table-hover table-bordered">
            <thead class="table-warning text-center">
                <tr>
                    <th style="width: 80px;">Ações</th>
                    <th style="width: 50px;">ID</th>
                    <th style="min-width: 200px;">Nome</th>
                    <th style="min-width: 130px;">CPF</th>
                    <th style="width: 100px;">Procuração</th>
                    <th style="border-left: 3px solid #f5ecb8; width: 10px;"></th>
                    <th style="min-width: 150px;">Data Solicitação</th>
                    <th style="min-width: 120px;">Tipo</th>
                    <th style="min-width: 150px;">Documentos</th>
                    <th style="min-width: 150px;">Conferência</th>
                    <th style="min-width: 150px;">Imposto a Pagar</th>
                    <th style="min-width: 100px;">Doação</th>
                    <th style="min-width: 150px;">Dados Doação</th>
                    <th style="min-width: 130px;">Parcelamento</th>
                    <th style="min-width: 150px;">Imposto a Restituir</th>
                    <th style="min-width: 130px;">Transmissão</th>
                    <th style="min-width: 150px;">Data Transmissão</th>
                    <th style="min-width: 160px;">Enviada ao Cliente</th>
                    <th style="min-width: 200px;">Observações</th>
                    <th style="min-width: 120px;">Valor Cobrado</th>
                    <th style="min-width: 140px;">Boleto Enviado</th>
                    <th style="min-width: 120px;">Pagamento</th>
                </tr>
            </thead>
            <tbody class="text-center" id="tabela-dados"></tbody>
        </table>
    </div>
</div>

<style>
    th:nth-child(6), td:nth-child(6) {
        border-left: 3px solid #f5ecb8;
        background-color: #f5ecb8;
    }
    .table {
        width: 100%;
    }
</style>

<!-- **************************************Modal de edição*************************************************-->

<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Campos do formulário para editar as informações do cliente -->
                <form id="editForm">
                    <!-- id do cliente da tabela cliente -->
                    
                        <input type="hidden" id="editIdCliente" name="id_cliente" />
                    
                    <!-- Data da Solicitação-->
                    <div class="mb-3">
                        <label for="editDataSolicitacao" class="form-label">Data Solicitação</label>
                        <input type="date" name="data_solicitacao" class="form-control" id="editDataSolicitacao">
                    </div>
                    <!-- Tipo -->
                    <div class="mb-3">
                        <label for="editTipo" class="form-label">Tipo</label>
                        <select name="tipo" class="form-select" id="editTipo">
                            <option value="" selected></option>
                            <option value="Basica">Básica</option>
                            <option value="Com Ações">Com Ações</option>
                            <option value="Com Espólio">Com Espólio</option>
                        </select>
                    </div>
                    <!-- Documentos -->
                    <div class="mb-3">
                        <label for="editDocumentos" class="form-label">Documentos</label>
                        <select name="documentos" class="form-select" id="editDocumentos">
                            <option value="" selected></option>
                            <option value="Pendente de Envio">Pendente de Envio</option>
                            <option value="Com Pendências">Com Pendências</option>
                            <option value="Enviados">Enviados</option>
                        </select>
                    </div>
                    <!-- Conferência -->
                    <div class="mb-3">
                        <label for="editConferencia" class="form-label">Conferência</label>
                        <select name="conferencia" class="form-select" id="editConferencia">
                            <option value="" selected ></option>
                            <option value="Pendente">Pendente</option>
                            <option value="Em Andamento">Em Andamento</option>
                            <option value="Conferido pelo Cliente">Conferido pelo Cliente</option>
                        </select>
                    </div>
                     <!-- Imposto a Pagar -->
                    <div class="mb-3">
                        <label for="editImpostoPagar" class="form-label">Imposto a Pagar</label>
                        <input type="text" name="imposto_pagar" class="form-control" id="editImpostoPagar" oninput="formatarMoeda(this)">
                    </div>
                    <script>
                    function formatarMoeda(input) {
                        let valor = input.value.replace(/\D/g, ""); // Remove tudo que não for número
                        valor = (valor / 100).toFixed(2) + ""; // Converte para decimal
                        valor = valor.replace(".", ","); // Substitui ponto por vírgula
                        valor = "R$ " + valor.replace(/\B(?=(\d{3})+(?!\d))/g, "."); // Adiciona separador de milhar
                        input.value = valor;
                    }
                    </script>
                    <!-- Doação -->
                    <div class="mb-3">
                        <label for="editDoacao" class="form-label">Doação</label>
                        <select name="doacao" class="form-select" id="editdoacao">
                            <option value="" selected></option>
                            <option value="Sim">Sim</option>
                            <option value="Não">Não</option>
                        </select>
                    </div>
                    <!-- Dados Doação -->
                    <div class="mb-3">
                        <label for="editDadosDoacao" class="form-label">Dados Doação</label>
                        <input type="text" name="dados_doacao" class="form-control" id="editDadosDoacao" placeholder="Nome da instituição.">
                    </div>
                    <!-- Parcelamento -->
                    <div class="mb-3">
                        <label for="editParcelamento" class="form-label">Parcelamento</label>
                        <select name="parcelamento" class="form-select" id="editParcelamento">
                            <option value="" selected></option>
                            <option value="1" >1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                    <!-- Imposto a Restituir -->
                    <div class="mb-3">
                        <label for="editImpostoRestituir" class="form-label">Imposto a Restituir</label>
                        <input type="text" name="imposto_restituir" class="form-control" id="editImpostoRestituir" oninput="formatarMoeda(this)">
                    </div>
                    <script>
                    function formatarMoeda(input) {
                        let valor = input.value.replace(/\D/g, ""); // Remove tudo que não for número
                        valor = (valor / 100).toFixed(2) + ""; // Converte para decimal
                        valor = valor.replace(".", ","); // Substitui ponto por vírgula
                        valor = "R$ " + valor.replace(/\B(?=(\d{3})+(?!\d))/g, "."); // Adiciona separador de milhar
                        input.value = valor;
                    }
                    </script>

                    <!-- Transmissão -->
                    <div class="mb-3">
                        <label for="editTransmissao" class="form-label">Trasmissão</label>
                        <select name="transmissao" class="form-select" id="editTransmissao">
                            <option value="" selected></option>
                            <option value="Pendente">Pendente</option>
                            <option value="Em Andamento">Em Andamento</option>
                            <option value="Transmitido">Transmitido</option>
                        </select>
                    </div>
                    <!-- Data Transmissão -->
                    <div class="mb-3">
                        <label for="editDataTransmissao" class="form-label">Data Transmissão</label>
                        <input type="date" name="data_transmissao" class="form-control" id="editDataTransmissao">
                    </div>
                    <!-- Enviada ao Cliente -->
                    <div class="mb-3">
                        <label for="editEnviadaCliente" class="form-label">Enviada ao Cliente</label>
                        <input type="date" name="enviada_cliente" class="form-control" id="editEnviadaCliente">
                    </div>
                    <!-- Observações -->
                    <div class="mb-3">
                        <label for="editObservacoes" class="form-label">Observações</label>
                        <input type="text" name="observacoes" class="form-control" id="editObservacoes">
                    </div>
                    <!-- Valor Cobrado -->
                   <div class="mb-3">
                        <label for="editValorCobrado" class="form-label">Valor cobrado</label>
                        <input type="text" name="valor_cobrado" class="form-control" id="editValorCobrado" oninput="formatarMoeda(this)">
                    </div>
                    <script>
                    function formatarMoeda(input) {
                        let valor = input.value.replace(/\D/g, ""); // Remove tudo que não for número
                        valor = (valor / 100).toFixed(2) + ""; // Converte para decimal
                        valor = valor.replace(".", ","); // Substitui ponto por vírgula
                        valor = "R$ " + valor.replace(/\B(?=(\d{3})+(?!\d))/g, "."); // Adiciona separador de milhar
                        input.value = valor;
                    }
                    </script>
                     <!-- Boleto Enviado -->
                    <div class="mb-3">
                        <label for="editBoletoEnviado" class="form-label">Boleto enviado</label>
                        <select name="boleto_enviado" class="form-select" id="editBoletoEnviado">
                            <option value="" selected></option>
                            <option value="Sim">Sim</option>
                            <option value="Não">Não</option>
                        </select>
                    </div>
                    <!-- Pagamento -->
                    <div class="mb-3">
                        <label for="editPagamento" class="form-label">Pagemento</label>
                        <select name="pagamento" class="form-select" id="editPagamento">
                            <option value="" selected></option>
                            <option value="Pendente">Pendente</option>
                            <option value="Pago">Pago</option>
                        </select>
                    </div>
                </form>
            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="saveEditButton">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!--************************************Script *****************************************************-->

<!--*********************************BUSCAR E RENDERIZAR NA TELA BLOCO 1********************************-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Função para buscar dados no backend
        async function buscarDados() {
            try {
                const resposta = await fetch('buscar_cliente.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `nomeCliente=${encodeURIComponent('')}`
                });

                if (!resposta.ok) throw new Error('Erro ao buscar dados');

                // Captura o texto bruto antes de converter para JSON
                const respostaTexto = await resposta.text();
                console.log('Resposta do servidor:', respostaTexto);

                try {
                    return JSON.parse(respostaTexto);
                } catch (erro) {
                    console.error('Erro ao converter JSON:', erro);
                    return { clientes: [], processos: [] };
                }

            } catch (erro) {
                console.error('Erro:', erro);
                return { clientes: [], processos: [] };
            }
        }

        // Função para renderizar os dados na tabela
        function renderizarTabela(dados) {
            const tbody = document.getElementById('tabela-dados');
            tbody.innerHTML = ''; // Limpa a tabela antes de inserir novos dados

            const clientes = dados.clientes || [];
            const processos = dados.processos || [];
            const maxLength = Math.max(clientes.length, processos.length);

            let linhas = []; // Criar um array para melhor desempenho

            for (let i = 0; i < maxLength; i++) {
                let cliente = clientes[i] || {};
                let processo = processos[i] || {};

                linhas.push(`
                    <tr>
                        <td>
                            <button class="btn btn-primary btn-sm editBtn" data-id="${cliente.cliente_id}" data-bs-toggle="modal" data-bs-target="#editModal">Editar</button>
                        </td>
                        <td>${cliente.cliente_id || '—'}</td>
                        <td>${cliente.nomeCliente || '—'}</td>
                        <td>${cliente.cpf || '—'}</td>
                        <td>${cliente.procuracao || '—'}</td>
                        <td style="border-left: 3px solid #f5ecb8;"></td>
                        <td>${processo.data_solicitacao || '—'}</td>
                        <td>${processo.tipo || '—'}</td>
                        <td>${processo.documentos || '—'}</td>
                        <td>${processo.conferencia || '—'}</td>
                        <td>${processo.imposto_pagar || '—'}</td>
                        <td>${processo.doacao || '—'}</td>
                        <td>${processo.dados_doacao || '—'}</td>
                        <td>${processo.parcelamento || '—'}</td>
                        <td>${processo.imposto_restituir || '—'}</td>
                        <td>${processo.transmissao || '—'}</td>
                        <td>${processo.data_transmissao || '—'}</td>
                        <td>${processo.enviada_cliente || '—'}</td>
                        <td>${processo.observacoes || '—'}</td>
                        <td>${processo.valor_cobrado || '—'}</td>
                        <td>${processo.boleto_enviado || '—'}</td>
                        <td>${processo.pagamento || '—'}</td>
                    </tr>
                `);
            }

            tbody.innerHTML = linhas.join('');
        }

        // Função principal para carregar e renderizar os dados
        async function carregarDados() {
            const dados = await buscarDados();
            renderizarTabela(dados);
        }

        // Carrega os dados quando a página for carregada
        window.onload = carregarDados;

        // Adiciona evento de clique aos botões de edição após a tabela ser carregada
        document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('tabela-dados').addEventListener('click', function(event) {
        if (event.target.classList.contains('editBtn')) {
            const idCliente = event.target.getAttribute('data-id');

            // Verificar se o ID do cliente foi capturado corretamente
            console.log('ID do cliente selecionado:', idCliente);

            if (!idCliente) {
                alert("Erro: ID do cliente não encontrado!");
                return;
            }

            // Preencher o campo oculto no formulário do modal
            document.getElementById('editIdCliente').value = idCliente;
        }
    });
});


        //***************************************SALVAR PROCESSOS********************************************************
        async function salvarProcesso() {
            const formData = new FormData(document.getElementById('editForm'));
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            try {
                const response = await fetch('salvar_processo.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.status === "success") {
                    alert("Dados salvos com sucesso!");

                    // Obtém a instância do modal e fecha
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                    if (modal) modal.hide();

                    carregarDados(); // Atualiza a tabela após salvar
                } else {
                    alert("Erro ao salvar os dados: " + result.message);
                }
            } catch (error) {
                console.error("Erro ao salvar:", error);
                alert("Erro ao salvar os dados. Verifique o console para mais detalhes.");
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('saveEditButton').addEventListener('click', function () {
        salvarProcesso();
    });
});

//***********************************mostra os dados no modal**********************************************

document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('tabela-dados').addEventListener('click', function (event) {
        if (event.target.classList.contains('editBtn')) {
            const idCliente = event.target.getAttribute('data-id');

            // Verificar se o ID do cliente foi capturado corretamente
            console.log('ID do cliente selecionado:', idCliente);

            if (!idCliente) {
                alert("Erro: ID do cliente não encontrado!");
                return;
            }

            // Capturar a linha da tabela onde o botão foi clicado
            const linha = event.target.closest('tr');

            // Capturar os dados da linha
            const dados = {
                idCliente: linha.cells[1].textContent.trim(),
                dataSolicitacao: linha.cells[6].textContent.trim(),
                tipo: linha.cells[7].textContent.trim(),
                documentos: linha.cells[8].textContent.trim(),
                conferencia: linha.cells[9].textContent.trim(),
                impostoPagar: linha.cells[10].textContent.trim(),
                doacao: linha.cells[11].textContent.trim(),
                dadosDoacao: linha.cells[12].textContent.trim(),
                parcelamento: linha.cells[13].textContent.trim(),
                impostoRestituir: linha.cells[14].textContent.trim(),
                transmissao: linha.cells[15].textContent.trim(),
                dataTransmissao: linha.cells[16].textContent.trim(),
                enviadaCliente: linha.cells[17].textContent.trim(),
                observacoes: linha.cells[18].textContent.trim(),
                valorCobrado: linha.cells[19].textContent.trim(),
                boletoEnviado: linha.cells[20].textContent.trim(),
                pagamento: linha.cells[21].textContent.trim()
            };

            // Preencher os campos do modal com os dados capturados
            document.getElementById('editIdCliente').value = dados.idCliente;
            document.getElementById('editDataSolicitacao').value = dados.dataSolicitacao;
            document.getElementById('editTipo').value = dados.tipo;
            document.getElementById('editDocumentos').value = dados.documentos;
            document.getElementById('editConferencia').value = dados.conferencia;
            document.getElementById('editImpostoPagar').value = dados.impostoPagar;
            document.getElementById('editdoacao').value = dados.doacao;
            document.getElementById('editDadosDoacao').value = dados.dadosDoacao;
            document.getElementById('editParcelamento').value = dados.parcelamento;
            document.getElementById('editImpostoRestituir').value = dados.impostoRestituir;
            document.getElementById('editTransmissao').value = dados.transmissao;
            document.getElementById('editDataTransmissao').value = dados.dataTransmissao;
            document.getElementById('editEnviadaCliente').value = dados.enviadaCliente;
            document.getElementById('editObservacoes').value = dados.observacoes;
            document.getElementById('editValorCobrado').value = dados.valorCobrado;
            document.getElementById('editBoletoEnviado').value = dados.boletoEnviado;
            document.getElementById('editPagamento').value = dados.pagamento;
        }
    });
});


    </script>

</body>
</html>